<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Number of Fire Departments by Location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/d3@5.16.0/dist/d3.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .axis path,
        .axis line {
            fill: none;
            stroke: #333;
        }

        .grid .tick {
            stroke: lightgrey;
            opacity: 0.7;
        }

        .y-grid .tick {
            stroke-dasharray: 5;
            stroke: lightgrey;
            opacity: 0.7;
        }

        .grid path {
            stroke-width: 0;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
            opacity: .3;
        }

        .line1 {
            fill: none;
            stroke: green;
            stroke-width: 1.5px;
            opacity: .6;
        }

        .line2 {
            fill: none;
            stroke: red;
            stroke-width: 1.5px;
            opacity: .6;
        }

        .line3 {
            fill: none;
            stroke: blue;
            stroke-width: 1.5px;
            opacity: .6;
        }

        .dot1 {
            fill: green;
            cursor: pointer;
        }

        .dot2 {
            fill: red;
            cursor: pointer;
        }

        .dot3 {
            fill: blue;
            cursor: pointer;
        }

        div.line1_tt,
        div.line2_tt,
        div.line3_tt {
            position: absolute;
            text-align: center;
            width: 100px;
            height: 38px;
            padding: 5px;
            font: 12px sans-serif;
            background: #abd6b6;
            border: 0px;
            pointer-events: none;
            border-radius: 2px;
            color: #000000;
        }

        div.line2_tt {
            background: #fbc4ba;
        }

        div.line3_tt {
            background: #b2c3ff;
        }

        .legend rect {
            fill: #8da0cb;
        }
    </style>
</head>
<body>
    <h2>Number of Fire Departments by Location</h2>
    <div class="widget" style="width:630px">
        <div class="header">Number of Fire Departments by Location</div>
        <div id="chart" class="chart-container" style="padding:5px"></div>
    </div>
    <h2>Fire Departments Map</h2>
    <div id="map" style="height: 500px;"></div>

    <script>
        const sqlQuery = `SELECT * FROM "e4ab410d-5119-4126-8411-8f7700d3c0bf"`;

        axios.get(`https://data.boston.gov/api/3/action/datastore_search_sql?sql=${encodeURIComponent(sqlQuery)}`)
            .then(function(response) {
                const data = response.data.result.records;

                // Process data for line chart
                const counts = d3.nest()
                    .key(function(d) { return d.PD; })
                    .key(function(d) { return d.Year; })
                    .rollup(function(v) { return v.length; })
                    .entries(data)
                    .map(function(d) {
                        return {
                            PD: d.key,
                            values: d.values.map(function(v) {
                                return { Year: +v.key, Count: v.value };
                            })
                        };
                    });

                // Line Chart
                const margin = {top: 50, right: 35, bottom: 50, left: 50},
                      width = 630 - margin.left - margin.right,
                      height = 500 - margin.top - margin.bottom;

                const svg = d3.select("#chart").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleLinear()
                    .domain(d3.extent(data, function(d) { return +d.Year; }))
                    .rangeRound([0, width]);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(counts, function(c) { return d3.max(c.values, function(d) { return d.Count; }); })])
                    .nice()
                    .range([height, 0]);

                const xAxis = d3.axisBottom(x).ticks(10);
                const yAxis = d3.axisLeft(y).ticks(10);

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", `translate(0,${height})`)
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);

                const line = d3.line()
                    .x(function(d) { return x(d.Year); })
                    .y(function(d) { return y(d.Count); });

                counts.forEach(function(c) {
                    svg.append("path")
                        .datum(c.values)
                        .attr("class", `line line${c.PD}`)
                        .attr("d", line);

                    svg.selectAll(`.dot${c.PD}`)
                        .data(c.values)
                        .enter().append("circle")
                        .attr("class", `dot dot${c.PD}`)
                        .attr("cy", function(d) { return y(d.Count); })
                        .attr("cx", function(d) { return x(d.Year); })
                        .attr("r", 4)
                        .on("mouseover", function(d) {
                            const div = d3.select(`.line${c.PD}_tt`);
                            div.transition()
                                .duration(200)
                                .style("opacity", .9);
                            div.html(`<b>Year:</b> ${d.Year}<br/><b>Count:</b> ${d.Count}`)
                                .style("left", `${d3.event.pageX}px`)
                                .style("top", `${d3.event.pageY - 50}px`);
                            d3.select(this).attr("r", 7);
                            d3.selectAll(`.line`).style("opacity", ".1");
                            d3.selectAll(`.dot`).style("opacity", 0.1);
                            d3.select(`.line${c.PD}`).style("opacity", "1").style("stroke-width", "2px");
                            d3.selectAll(`.dot${c.PD}`).style("opacity", 1);
                        })
                        .on("mouseout", function(d) {
                            const div = d3.select(`.line${c.PD}_tt`);
                            div.transition()
                                .duration(200)
                                .style("opacity", 0);
                            d3.select(this).attr("r", 4);
                            d3.selectAll(`.line`).style("opacity", ".6").style("stroke-width", "1.5px");
                            d3.selectAll(`.dot`).style("opacity", 1);
                        });
                });

                const legend = svg.selectAll(".legend")
                    .data(counts)
                    .enter().append("g")
                    .attr("class", "legend")
                    .attr("transform", function(d, i) { return `translate(${i * 200 + 20}, -30)`; });

                legend.append("rect")
                    .attr("width", 10)
                    .attr("height", 10)
                    .style("fill", function(d) { return color(d.PD); })
                    .style("stroke", function(d) { return color(d.PD); });

                legend.append("text")
                    .attr("x", 15)
                    .attr("y", 9)
                    .text(function(d) { return d.PD; })
                    .style("fill", "#000000")
                    .style("font-size", "12px");

                // Map Visualization
                var map = L.map('map').setView([42.3601, -71.0589], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
                    maxZoom: 18,
                }).addTo(map);

                var markers = L.markerClusterGroup().addTo(map);

                data.forEach(function(row) {
                    var marker = L.marker([row.Y, row.X]).bindPopup(
                        row.LOCNAME + '<br>Contact: ' + row.LOCCONTACT + '<br>Address: ' + row.LOCADDR
                    );
                    markers.addLayer(marker);
                });

                // Highlight areas and count fire departments in each area
                var areaCounts = d3.nest()
                    .key(function(d) { return d.PD; })
                    .rollup(function(leaves) { return leaves.length; })
                    .entries(data);

                areaCounts.forEach(function(area) {
                    var areaData = data.filter(function(d) { return d.PD === area.key; });
                    var areaLat = d3.mean(areaData, function(d) { return +d.Y; });
                    var areaLon = d3.mean(areaData, function(d) { return +d.X; });

                    L.circleMarker([areaLat, areaLon], {
                        radius: 10,
                        color: 'blue',
                        fillColor: 'blue',
                        fillOpacity: 0.6
                    }).bindPopup(area.key + '<br>Fire Departments: ' + area.value).addTo(map);
                });
            })
            .catch(function(error) {
                console.error('Error fetching data:', error);
            });
    </script>
</body>
</html>
